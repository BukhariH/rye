<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
  <head>
    <title>File: README.rdoc [Rye: Safely run SSH commands on a bunch of machines at the same time (from Ruby).]</title>
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <link href='../rdoc-style.css' media='screen' rel='stylesheet' type='text/css'>
    <script type='text/javascript'>
      //<![CDATA[
        function popupCode(url) {
          window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
        }
        
        function toggleCode(id) {
          var code = document.getElementById(id)
        
          code.style.display = code.style.display != 'block' ? 'block' : 'none'
          return true
        }
        
        // Make codeblocks hidden by default
        document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
      //]]>
    </script>
  </head>
  <body class='page'>
    <div class='file' id='wrapper'>
      <div class='header'>
        <div class='name'>README.rdoc</div>
        <div class='paths'>
          README.rdoc
        </div>
        <div class='last-update'>
          Last Update:
          <span class='datetime'>2010-02-25 14:06:12 -0500</span>
        </div>
      </div>
      <div id='content'>
        <div id='text'>
          <div id='description'>
            <h1><a href="../classes/Rye.html">Rye</a> - v0.8</h1>
            <p>
            <b>Safely run SSH commands on a bunch of machines at the same time (from
            Ruby)</b>.
            </p>
            <p>
            Inspired by <a href="http://rush.heroku.com">Rush</a> and compatible with
            Ruby 1.8, 1.9, and JRuby 1.3+!
            </p>
            <h2>Overview</h2>
            <p>
            <a href="../classes/Rye.html">Rye</a> is a Ruby abstraction for executing
            shell commands via SSH. By default, <a href="../classes/Rye.html">Rye</a>
            errs on the side of caution by running in &#8220;safe-mode&#8221; which
            specifies a default whitelist of commands and aggressively escapes all
            command arguments. For example, file globs and the &#8220;rm&#8221; command
            are not available in safe-mode, so you can&#8217;t do this:
            <tt>rbox.rm('-rf', '/etc/*<b>/</b>')</tt>.
            </p>
            <p>
            <a href="../classes/Rye.html">Rye</a> does not require anything to be
            installed on the server side (other than an SSH daemon) so it can be run
            from any machine with Ruby, OpenSSL, and OpenSSH.
            </p>
            <h3>SSH keys</h3>
            <p>
            You need SSH keys to use <a href="../classes/Rye.html">Rye</a>. After
            installing <a href="../classes/Rye.html">Rye</a>, you can check if you have
            any by running:
            </p>
            <pre>$ rye</pre>
            <p>
            If you get the message <em>&#8220;The agent has no identities&#8220;</em>
            you will need to generate a keypair.
            </p>
            <pre>$ ssh-keygen</pre>
            <h3>Passwordless SSH authorization</h3>
            <p>
            The easiest way to work with <a href="../classes/Rye.html">Rye</a> is to
            authorize your remote accounts for passwordless logins (otherwise
            you&#8217;ll be prompted for a password for every connection).
            </p>
            <p>
            Enable passwordless logins to remote HOST1 and HOST2:
            </p>
            <pre>$ rye authorize HOST1 HOST2</pre>
            <p>
            This will copy your public SSH keys to the <tt>~/.ssh/authorized_keys</tt>
            and <tt>~/.ssh/authorized_keys2</tt> files on the remote machine(s).
            </p>
            <p>
            Enable passwordless logins to the local machine:
            </p>
            <pre>$ rye authorize-local</pre>
            <p>
            See <tt>rye -h</tt> for more info.
            </p>
            <h2>Example 1 &#8212; Execute commands on a remote machine</h2>
            <p>
            Shell commands are executed by calling methods on a <a
            href="../classes/Rye/Box.html">Rye::Box</a> object.
            </p>
            <pre>rbox = Rye::Box.new('hostname')&#x000A;rbox.pwd                               # =&gt; &quot;/home/rye&quot;&#x000A;rbox.uname :a                          # =&gt; &quot;Darwin rye-stage 9.7.0 ...&quot;</pre>
            <p>
            Method arguments are sent directly as arguments to the shell command.
            Single-character Symbols are assumed to be single-character switches.
            <em>e.g. <tt>rbox.uname :a</tt> becomes <tt>uname -a</tt>.</em>
            </p>
            <p>
            The return value for a command is a modified Array containing the contents
            of STDOUT split by line. It also gives access to STDERR and the exit code
            </p>
            <pre>ret = rbox.uptime                      # =&gt; &quot;11:02  up 16:01, 3 users&quot;&#x000A;ret.stderr                             # =&gt; []&#x000A;ret.exit_code                          # =&gt; 0&#x000A;ret.stdout                             # =&gt; &quot;11:02  up 16:01, 3 users&quot;&#x000A;ret.stdout.class                       # =&gt; Array&#x000A;ret.class                              # =&gt; Rye::Rap</pre>
            <h2>Example 2 &#8212; Paths and environment variables</h2>
            <p>
            You can change directories.
            </p>
            <pre>rbox.cd '/tmp'&#x000A;rbox.pwd                               # =&gt; '/tmp'&#x000A;rbox['/etc'].ls                        # =&gt; ['apache', 'init.d', ...]&#x000A;rbox.pwd                               # =&gt; '/etc'&#x000A;rbox.cd                                # =&gt; '/home/rye'</pre>
            <p>
            You can specify environment variables.
            </p>
            <pre>rbox.setenv('TIPPLE', &quot;Forty Creek&quot;)&#x000A;rbox.getenv 'TIPPLE'                   # =&gt; &quot;Forty Creek&quot;</pre>
            <h2>Example 3 &#8212; Adding and removing commands</h2>
            <p>
            You can add and remove commands to the whitelist.
            </p>
            <pre>rbox.add_command :anything, '/path/2/anything'&#x000A;rbox.anything&#x000A;rbox.remove_command :anything&#x000A;rbox.anything                          # =&gt; Rye::CommandNotFound exception</pre>
            <h2>Example 4 &#8212; Disabling Safe Mode</h2>
            <p>
            Safe mode can be disabled on one of the following ways.
            </p>
            <pre>rbox = Rye::Box.new 'HOST', :safe =&gt; false&#x000A;  OR&#x000A;rbox.disable_safe_mode</pre>
            <p>
            When safe-mode is disabled, you can run any command (regardless of what is
            defined in the whitelist) with any valid arguments (fileglobs, tildas,
            etc...).
            </p>
            <pre>rbox.kill '-SIGHUP', 1928111&#x000A;rbox.rm 'path/2/*'</pre>
            <p>
            You can also execute any valid shell command.
            </p>
            <pre>rbox.execute 'ps aux | grep ruby &gt; /tmp/ruby-process-list'</pre>
            <p>
            See the &#8220;About Safe Mode&#8221; section below for more information.
            </p>
            <h2>Example 5a &#8212; Accessing Multiple Machines</h2>
            <p>
            Shell commands can be executed on multiple machines using a <a
            href="../classes/Rye/Set.html">Rye::Set</a> object. Create a
            &#8220;set&#8221; of machines.
            </p>
            <pre>rbox = Rye::Box.new 'HOST1'&#x000A;rset = Rye::Set.new&#x000A;rset.add_boxes rbox, 'HOST2'           # Add boxes as hostnames or objects</pre>
            <p>
            Then call methods just like with <a
            href="../classes/Rye/Box.html">Rye::Box</a>, except now the return value is
            an Array of Arrays. The order of return values matches the order the
            machines were added to the set.
            </p>
            <pre>rset.hostname                          # =&gt; [[&quot;HOST1&quot;], [&quot;HOST2&quot;]]&#x000A;rset.uname                             # =&gt; [[&quot;Darwin&quot;], [&quot;Linux&quot;]]</pre>
            <h2>Example 5b &#8212; Accessing Multiple Machines in Parallel</h2>
            <p>
            By default, <a href="../classes/Rye/Set.html">Rye::Set</a> connects to each
            machine sequentially in the order they were added to the set. Commands can
            also be run in parallel.
            </p>
            <pre>rset = Rye::Set.new &quot;SETNAME&quot;, :parallel =&gt; true&#x000A;  OR&#x000A;rset.parallel = true</pre>
            <h2>Example 6 &#8212; File Transfers</h2>
            <pre>rbox = Rye::Box.new &quot;localhost&quot;&#x000A;&#x000A;rbox.file_upload &quot;README.rdoc&quot;, &quot;/tmp&quot;&#x000A;&#x000A;applejack = StringIO.new &quot;Some in-memory content&quot;&#x000A;rbox.file_upload applejack, &quot;/tmp/applejack.txt&quot;&#x000A;&#x000A;rbox.ls &quot;/tmp/&quot;                 # =&gt; [README.rdoc, applejack.txt]&#x000A;rbox.cat &quot;/tmp/applejack.txt&quot;   # =&gt; &quot;Some in-memory content&quot;&#x000A;&#x000A;filecontent = StringIO.new&#x000A;rbox.file_download &quot;/tmp/applejack.txt&quot;, filecontent&#x000A;&#x000A;filecontent.read                # =&gt; &quot;Some in-memory content&quot;</pre>
            <h2>Example 7 &#8212; Local processes</h2>
            <p>
            For local processes, you can bypass <tt>Rye::Box</tt> and execute commands
            directly with <tt><a href="../classes/Rye.html#M000011">Rye.shell</a></tt>:
            </p>
            <pre>Rye.shell :uptime    # =&gt; 11:02  up 16:01, 3 users</pre>
            <p>
            The first argument must be the command name and the remaining arguments are
            sent directly as arguments to the command. They&#8217;re not escaped like
            with <tt>Rye::Box</tt> so you can use the asterisk, environment variables,
            pipes, and redirects etc. Also note that you can specify single character
            switches as symbols and you can separate arguments or put them into a
            single String.
            </p>
            <pre>Rye.shell :ls, '*'&#x000A;Rye.shell :ls, '-l $HOME'&#x000A;Rye.shell :ls, :l, '$HOME &gt; $TMPDIR/crazy.txt'</pre>
            <p>
            The return value is a <a href="../classes/Rye/Rap.html">Rye::Rap</a> object
            (just like with <a href="../classes/Rye/Box.html">Rye::Box</a>) so you have
            access to the exit code and STDERR output:
            </p>
            <pre>ret = Rye.shell :ls, 'nofile'&#x000A;ret.exit_code        # =&gt; 1&#x000A;ret.stderr           # =&gt; &quot;sh: nofile: No such file or directory&quot;&#x000A;ret.class            # =&gt; Rye::Rap</pre>
            <h2>About Safe-Mode</h2>
            <p>
            In safe-mode:
            </p>
            <ul>
            <li>You can&#8217;t use file globs. This means you can&#8217;t do this:
            <tt>rbox.ls('*.rb')</tt>. <tt>~</tt> also doesn&#8217;t work!
            
            </li>
            <li>You can&#8217;t use environment variables as arguments. This means you
            can&#8217;t do this: <tt>rbox.echo('$HOME')</tt>. However, environment
            variables are available to the commands you run.
            
            </li>
            <li>Pipes and operators don&#8217;t work: <tt>|, &amp;&amp;, &gt;, &lt;, ||,
            ~</tt>, etc...
            
            </li>
            <li>Backticks don&#8217;t work either: <tt>procs=`ps aux`</tt>
            
            </li>
            </ul>
            <p>
            Why? In safe-mode, all command arguments are escaped which turns all
            arguments into their literal values.
            </p>
            <p>
            Using a Ruby interface to execute shell commands is pretty awesome,
            particularly to run them on several machines simultaneously. That&#8217;s a
            lot of power and it&#8217;s potentially very dangerous. That&#8217;s why <a
            href="../classes/Rye.html">Rye</a> disables this stuff by default.
            There&#8217;s probably a way to do it safely but it&#8217;s not obvious yet
            (to me). If you have any ideas, I&#8217;d love to hear them!
            </p>
            <h2>Command Whitelist</h2>
            <p>
            <a href="../classes/Rye.html">Rye</a> permits only a limited number of
            system commands to be run. This default whitelist is defined in <a
            href="http://github.com/delano/rye/blob/master/lib/rye/cmd.rb">Rye::Cmd</a>
            but you can add your own commands as you please (see Example 3).
            </p>
            <h2>Dependencies</h2>
            <ul>
            <li><a href="http://www.openssh.com/">OpenSSH</a>
            
            </li>
            <li><a href="http://www.openssl.org">OpenSSL</a> (The C library)
            
            </li>
            <li>Ruby Gems:
            
            <ul>
            <li>net-ssh
            
            </li>
            <li>net-scp
            
            </li>
            <li>highline
            
            </li>
            <li>drydock
            
            </li>
            <li>sysinfo
            
            </li>
            <li>storable
            
            </li>
            </ul>
            </li>
            </ul>
            <h2>Installation</h2>
            <p>
            Via Rubygems, one of:
            </p>
            <pre>$ gem install rye&#x000A;$ gem install delano-rye --source http://gems.github.com/</pre>
            <p>
            or via download:
            </p>
            <ul>
            <li><a href="http://github.com/delano/rye/tarball/latest">rye-latest.tar.gz</a>
            
            </li>
            <li><a href="http://github.com/delano/rye/zipball/latest">rye-latest.zip</a>
            
            </li>
            </ul>
            <h2>Known Issues</h2>
            <ul>
            <li><a href="../classes/Rye.html">Rye</a> doesn&#8217;t read the ~/.ssh/config
            file yet
            
            </li>
            <li><a href="../classes/Rye.html">Rye</a> uses OpenSSH&#8217;s ssh-agent (if it
            exists). <a href="../classes/Rye.html">Rye</a> starts it up as a child
            process and shuts it down using at_exit. If you have code in an at_exit
            that rely&#8217;s on <a href="../classes/Rye.html">Rye</a>, make sure your
            code runs before Rye&#8217;s at_exit block is called. For example, Drydock
            uses at_exit too which is why in <a href="bin/rye.html">bin/rye</a> you can
            see that Drydock is called explicitly so that Rye&#8217;s at_exit is
            executed after Drydock executes a command.
            
            </li>
            <li>No support for STDIN for commands.
            
            </li>
            <li>Limited support for interactive shells.
            
            </li>
            </ul>
            <p>
            If you find one let me know!
            </p>
            <h2>Thanks</h2>
            <ul>
            <li>Kalin Harvey (<a href="http://rely.ca">rely.ca</a>)
            
            </li>
            <li><a href="http://github.com/adamwiggins/rush">Rush</a> and <a
            href="http://github.com/jamis/capistrano/blob/master/lib/capistrano/shell.rb">Capistrano</a>
            for the inspiration.
            
            </li>
            <li>Mike Cline for giving the okay to use the <a
            href="../classes/Rye.html">Rye</a> name.
            
            </li>
            <li>Justin Case (<a
            href="http://github.com/justincase/">github.com/justincase/</a>) for fixes
            
            </li>
            </ul>
            <h2>More Info</h2>
            <ul>
            <li><a href="http://github.com/delano/rye">Codes</a>
            
            </li>
            <li><a href="http://delano.github.com/rye">Rdocs</a>
            
            </li>
            <li><a href="http://www.youtube.com/watch?v=_StUVh6ENuw">Inspiration</a>
            
            </li>
            </ul>
            <h2>Related Projects</h2>
            <ul>
            <li><a href="http://github.com/adamwiggins/rush">Rush</a>
            
            </li>
            </ul>
            <h2>Credits</h2>
            <ul>
            <li>Delano (@solutious.com)
            
            </li>
            <li>Escape, Copyright (C) 2006,2007 Tanaka Akira <akr@fsij.org>
            
            </li>
            <li><a href="../classes/Rye/Box.html#M000159">Rye::Box#instance_exec</a> (for
            Ruby 1.8) Mauricio Fernandez
            
            </li>
            </ul>
            <h2>License</h2>
            <p>
            See: <a href="LICENSE_txt.html">LICENSE.txt</a>
            </p>
          </div>
          <div id='section'>
          </div>
        </div>
      </div>
      <div id='footer-push'></div>
    </div>
    <div id='footer'>
      <a href="http://github.com/mislav/hanna/tree/master"><strong>Hanna</strong> RDoc template</a>
    </div>
  </body>
</html>
