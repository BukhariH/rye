<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta content="text/html; charset=utf-8" http-equiv="Content-Type" />

  <title>File: try [Rye: Safely run SSH commands on a bunch of machines at the same time (from Ruby).]</title>

  <link type="text/css" media="screen" href="../rdoc.css" rel="stylesheet" />

  <script src="../js/jquery.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="../js/thickbox-compressed.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="../js/quicksearch.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="../js/darkfish.js" type="text/javascript"
    charset="utf-8"></script>
</head>

<body class="file">
  <div id="metadata">
    <div id="home-metadata">
      <div id="home-section" class="section">
        <h3 class="section-header">
          <a href="../index.html">Home</a>
          <a href="../index.html#classes">Classes</a>
          <a href="../index.html#methods">Methods</a>
        </h3>
      </div>
    </div>

    <div id="project-metadata">
      
      
      <div id="fileindex-section" class="section project-section">
        <h3 class="section-header">Files</h3>
        <ul>
        
          <li class="file"><a href="../CHANGES_txt.html">CHANGES.txt</a></li>
        
          <li class="file"><a href="../LICENSE_txt.html">LICENSE.txt</a></li>
        
          <li class="file"><a href="../README_rdoc.html">README.rdoc</a></li>
        
          <li class="file"><a href="../bin/try.html">try</a></li>
        
        </ul>
      </div>
      

      <div id="classindex-section" class="section project-section">
        <h3 class="section-header">Class Index
          <span class="search-toggle"><img src="../images/find.png"
            height="16" width="16" alt="[+]"
            title="show/hide quicksearch" /></span></h3>
        <form action="#" method="get" accept-charset="utf-8" class="initially-hidden">
        <fieldset>
          <legend>Quicksearch</legend>
          <input type="text" name="quicksearch" value=""
            class="quicksearch-field" />
        </fieldset>
        </form>

        <ul class="link-list">
        
          <li><a href="../Rye.html">Rye</a></li>
        
          <li><a href="../Rye/Box.html">Rye::Box</a></li>
        
          <li><a href="../Rye/Box/InstanceExecHelper.html">Rye::Box::InstanceExecHelper</a></li>
        
          <li><a href="../Rye/Cmd.html">Rye::Cmd</a></li>
        
          <li><a href="../Rye/CommandNotFound.html">Rye::CommandNotFound</a></li>
        
          <li><a href="../Rye/Err.html">Rye::Err</a></li>
        
          <li><a href="../Rye/Hop.html">Rye::Hop</a></li>
        
          <li><a href="../Rye/Key.html">Rye::Key</a></li>
        
          <li><a href="../Rye/Key/BadFile.html">Rye::Key::BadFile</a></li>
        
          <li><a href="../Rye/Key/BadPerm.html">Rye::Key::BadPerm</a></li>
        
          <li><a href="../Rye/NoBoxes.html">Rye::NoBoxes</a></li>
        
          <li><a href="../Rye/NoHost.html">Rye::NoHost</a></li>
        
          <li><a href="../Rye/NoPassword.html">Rye::NoPassword</a></li>
        
          <li><a href="../Rye/NoPty.html">Rye::NoPty</a></li>
        
          <li><a href="../Rye/NotConnected.html">Rye::NotConnected</a></li>
        
          <li><a href="../Rye/Rap.html">Rye::Rap</a></li>
        
          <li><a href="../Rye/RyeError.html">Rye::RyeError</a></li>
        
          <li><a href="../Rye/Set.html">Rye::Set</a></li>
        
          <li><a href="../Rye/Tpl.html">Rye::Tpl</a></li>
        
        </ul>
        <div id="no-class-search-results" style="display: none;">No matching classes.</div>
      </div>

      
    </div>
  </div>

  <div id="documentation">
    
<p># <a href="../Rye.html">Rye</a> -- A working example # # If your reading
this via the rdocs you won't be able to see the code # See: <a
href="http://github.com/delano/rye/blob/master/bin/try">github.com/delano/rye/blob/master/bin/try</a>
# # Usage: bin/try #</p>

<p>RYE_HOME = File.join(File.dirname(__FILE__), '..') $:.unshift
File.join(RYE_HOME, 'lib') %w{net-ssh sysinfo storable drydock}.each {
|dir| $:.unshift File.join(File.dirname(__FILE__), '..', '..', dir, 'lib')
}</p>

<p>require 'stringio' require 'yaml' require 'rye'</p>

<p>puts %Q( #
------------------------------------------------------------------ #  
EXAMPLE 1 -- Basic Usage #)</p>

<p>rbox = <a href="../Rye/Box.html#method-c-new">Rye::Box.new</a>('localhost')</p>

<p># Commands are run as methods on the <a href="../Rye/Box.html">Rye::Box</a>
object puts rbox.uptime                   # =&gt; 11:02  up 16:01, 3 users</p>

<p># The response value for all commands is a <a
href="../Rye/Rap.html">Rye::Rap</a> object. The rap is a # subclass of
Array so you can treat it as an Array, but it can also act  # like a String
if there's only one element.  p rbox.ls(:a, '/')                 # =&gt;
['.', '..', 'bin', 'etc', ...]</p>

<p># You can change directories puts rbox.pwd                      # =&gt;
/home/rye puts <a href="http://'/usr/bin'">rbox</a>.pwd          # =&gt;
/usr/bin puts rbox.pwd                      # =&gt; /usr/bin</p>

<p># You can specify environment variables rbox.setenv(:RYE, "Forty Creek")
rbox.env                           # =&gt; ['HOME=/home/rye', 'RYE=Forty
Creek', ...]</p>

<p># The commands method returns an Array of available commands:              
puts rbox.commands.join(', ')      # =&gt; pwd, touch, echo, wc, ...</p>

<p># When you're done you can disconnect explicitly.  # (Although <a
href="../Rye.html">Rye</a> does this automatically at exit.)
rbox.disconnect</p>

<p>puts %Q( #
------------------------------------------------------------------ #  
EXAMPLE 2 -- Disabling Safe-Mode #)</p>

<p>rbox_safe = <a
href="../Rye/Box.html#method-c-new">Rye::Box.new</a>('localhost') rbox_wild
= <a href="../Rye/Box.html#method-c-new">Rye::Box.new</a>('localhost',
:safe =&gt; false)</p>

<p># Safe-mode is enabled by default. In safe-mode, all command  # arguments
are thoroughly escaped. This prevents access to # environment variables and
file globs (among other things). p rbox_safe.echo('$HOME')                 
# =&gt; "$HOME" p <a href="http://'/etc'">rbox_safe</a>.ls('host*')  rescue
<a href="../Rye/Err.html">Rye::Err</a>    # Doesn't exist p
rbox_safe.ls('-l | wc -l')     rescue <a
href="../Rye/Err.html">Rye::Err</a>    # =&gt; '|' is not a valid ls arg</p>

<p># Here's the same commands with safe-mode disabled: p
rbox_wild.echo('$HOME')                   # =&gt; "/home/rye" p <a
href="http://'/etc'">rbox_wild</a>.ls('host*')             # =&gt;
["hostconfig", "hosts"] p rbox_wild.ls('-l | wc -l')                # =&gt;
110 p rbox_wild.echo('$HOME &gt; /tmp/rye-home')   # =&gt;  p
rbox_wild.cat('/tmp/rye-home')            # =&gt; "/home/rye"</p>

<p>puts %Q( #
------------------------------------------------------------------ #  
EXAMPLE 3 -- Custom Commands #)</p>

<p>rbox = <a href="../Rye/Box.html#method-c-new">Rye::Box.new</a>('localhost')
rbox.add_keys('/private/key/path')   # Specify additional private keys</p>

<p># There's currently no rye900 command p rbox.command?('rye9000')   # =&gt;
false</p>

<p># But we can add our own commands to the <a
href="../Rye/Cmd.html">Rye::Cmd</a> class. They  # automatically become
available to all <a href="../Rye/Box.html">Rye::Box</a> objects. module <a
href="../Rye/Cmd.html">Rye::Cmd</a></p>

<pre>def rye9000(*args)
  run_command(&quot;ls&quot;, args)
end
def somescript(*args)
  run_command(&quot;/path/to/my/script&quot;, args)
end</pre>

<p>end</p>

<p># We can now run rye9000 (with arguments) p rbox.rye9000('-a')             
# =&gt; [".", "..", ".bashrc", ...] p rbox.command?('rye9000')           #
=&gt; true</p>

<p>puts %Q( #
------------------------------------------------------------------ #  
EXAMPLE 4 -- Accessing Multiple Machines #)</p>

<p>rset = <a href="../Rye/Set.html#method-c-new">Rye::Set.new</a>('default',
:parallel =&gt; true) rbox = <a
href="../Rye/Box.html#method-c-new">Rye::Box.new</a> p rbox</p>

<p>rset.add_keys('/private/key/path')     # For passwordless logins 
rset.add_boxes(rbox, '127.0.0.1')      # Add boxes as hostnames or objects</p>

<p># Calling methods on <a href="../Rye/Set.html">Rye::Set</a> objects is very
similar to calling them on # <a href="../Rye/Box.html">Rye::Box</a>
objects. In fact, it's identical: p rset.uptime        # =&gt; [[14:19:02
up 32 days, 19:35 ...], [14:19:02 up 30 days, 01:35]] p <a
href="http://'/usr'">rset</a>.ls    # =&gt; [['bin', 'etc', ...], ['bin',
'etc', ...]]</p>

<p># Like <a href="../Rye/Box.html">Rye::Box</a>, the response value is a <a
href="../Rye/Rap.html">Rye::Rap</a> object containing the # responses from
each box. Each response is itself a <a href="../Rye/Rap.html">Rye::Rap</a>
object. unames = rset.uname p unames                               # =&gt;
[["Darwin"], ["Darwin"]] puts unames.class                      # =&gt; <a
href="../Rye/Rap.html">Rye::Rap</a></p>

<p># The <a href="../Rye/Rap.html">Rye::Rap</a> object also keeps a reference
to the object that called the  # command. In this case, it will keep a
reference to Rye::Set: puts unames.set.class                  # =&gt; <a
href="../Rye/Set.html">Rye::Set</a> puts unames.set == rset               
# =&gt; true puts unames.size                       # =&gt; 2 puts
unames.first                      # =&gt; Darwin puts unames.first.class   
# =&gt; <a href="../Rye/Rap.html">Rye::Rap</a> puts unames.first.box.class 
# =&gt; <a href="../Rye/Box.html">Rye::Box</a> puts unames.first.box ==
rbox          # =&gt; true</p>

<p># Envrionment variables can be set the same way as with <a
href="../Rye/Box.html">Rye::Box</a> rset.setenv(:RYE, "Forty Creek") p
rset.env.first.select { |env| env =~ /RYE/ }  # =&gt; ["RYE=Forty Creek"]</p>

<p>puts %Q( #
------------------------------------------------------------------ #  
EXAMPLE 5 -- ERROR HANDLING #)</p>

<p>rbox = <a href="../Rye/Box.html#method-c-new">Rye::Box.new</a>('localhost',
:safe =&gt; false) # Note: safe mode is off</p>

<p># <a href="../Rye.html">Rye</a> follows the standard convention of taking
exception to a non-zero  # exit code by raising a <a
href="../Rye/Err.html">Rye::Err</a>. In this case, rye9000.test # is not
found by the ls command. begin</p>

<pre>rbox.ls('rye.test')</pre>

<p>rescue <a href="../Rye/Err.html">Rye::Err</a> =&gt; ex</p>

<pre>puts ex.exit_status                  # =&gt; 1
puts ex.stderr                     # =&gt; ls: rye.test: No such file or directory</pre>

<p>end</p>

<p># The Rye:Rap response objects also give you the STDOUT and STDERR #
content separately. Here we redirect STDOUT to STDERR, so this # will
return nothing: puts rbox.uname('-a 1&gt;&amp;2').stdout    # =&gt;</p>

<p># It all went to STDERR: puts rbox.uname('-a 1&gt;&amp;2').stderr    #
=&gt; Darwin ryehost 9.6.0 ...</p>

<p># There were no actual errors so the exit code should be 0. puts
rbox.uname('-a 1&gt;&amp;2').exit_status # =&gt; 0</p>

<p>puts %Q( #
------------------------------------------------------------------ #  
EXAMPLE 6 -- FILE TRANSFERS #)</p>

<p>dir_upload = "#{<a
href="../Rye.html#method-c-sysinfo">Rye.sysinfo</a>.tmpdir}rye-upload"
dir_download = "#{<a
href="../Rye.html#method-c-sysinfo">Rye.sysinfo</a>.tmpdir}rye-download"</p>

<p>rbox = <a href="../Rye/Box.html#method-c-new">Rye::Box.new</a>("localhost",
:info =&gt; STDOUT)</p>

<p># <a href="../Rye.html">Rye</a> ships without an rm method (for safety!).
Here  # we add the rm method only to this instance of rbox. def
rbox.rm(*args); __allow('rm', args); end</p>

<p>rbox.rm(:r, :f, dir_upload) # Silently delete test dirs rbox.rm(:r, :f,
dir_download)</p>

<p>rbox.file_upload("#{RYE_HOME}/README.rdoc",</p>

<pre>&quot;#{RYE_HOME}/LICENSE.txt&quot;, dir_upload)</pre>

<p>applejack = StringIO.new("Some in-memory content")
rbox.file_upload(applejack, "#{dir_upload}/applejack.txt")</p>

<p>p rbox.ls(dir_upload)            # =&gt; [<a
href="../README_rdoc.html">README.rdoc</a>, <a
href="../LICENSE_txt.html">LICENSE.txt</a>, applejack.txt] p
rbox.cat("#{dir_upload}/applejack.txt")   # =&gt; "Some in-memory content"</p>

<p>filecontent = StringIO.new
rbox.file_download("#{dir_upload}/applejack.txt", filecontent)
filecontent.rewind            p filecontent.read</p>

<p>puts %Q( #
------------------------------------------------------------------ #  
EXAMPLE 7 -- FILE TRANSFERS w/ VARIABLE INTERPOLATION #)</p>

<p>dir_upload = "#{<a
href="../Rye.html#method-c-sysinfo">Rye.sysinfo</a>.tmpdir}rye-upload"
dir_download = "#{<a
href="../Rye.html#method-c-sysinfo">Rye.sysinfo</a>.tmpdir}rye-download"</p>

<p>rbox = <a href="../Rye/Box.html#method-c-new">Rye::Box.new</a>("localhost",
:info =&gt; STDOUT)</p>

<p># <a href="../Rye.html">Rye</a> ships without an rm method (for safety!).
Here  # we add the rm method only to this instance of rbox. def
rbox.rm(*args); __allow('rm', args); end</p>

<p>rbox.rm(:r, :f, dir_upload) # Silently delete test dirs rbox.rm(:r, :f,
dir_download)</p>

<p>template = StringIO.new("Can we use templates? &lt;%= 'Yes!' %&gt;")
rbox.mkdir dir_upload</p>

<p>rbox.template_write("#{dir_upload}/template.txt", template)</p>

<p>p rbox.ls(dir_upload)                      # =&gt; [template.txt] p
rbox.cat("#{dir_upload}/template.txt")   # =&gt; "Can we use templates?
Yes!"</p>

<p>puts %Q( #
------------------------------------------------------------------ #  
EXAMPLE 8 -- LOCAL PROCESSES #)</p>

<p>p <a href="../Rye.html#method-i-shell">Rye.shell</a> :uptime</p>

<p>p <a href="../Rye.html#method-i-shell">Rye.shell</a> :ls, '*' p <a
href="../Rye.html#method-i-shell">Rye.shell</a> :ls, '-l $HOME' p <a
href="../Rye.html#method-i-shell">Rye.shell</a> :ls, :l, '$HOME &gt;
crazy.txt'</p>

<p><a href="../Rye.html#method-i-shell">Rye.shell</a> :rm, 'crazy.txt'</p>

<p>ret = <a href="../Rye.html#method-i-shell">Rye.shell</a> :ls, 'nofile' p
ret.exit_status                    # =&gt; 1 p ret.stderr                  
# =&gt; "sh: nofile: No such file or directory" p ret.class                
# =&gt; <a href="../Rye/Rap.html">Rye::Rap</a></p>

  </div>

  <div id="validator-badges">
    <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
    <p><small>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish
      Rdoc Generator</a> 2</small>.</p>
  </div>
</body>
</html>

